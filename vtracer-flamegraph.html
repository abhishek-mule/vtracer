<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vtracer - Interactive Flame Graph</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: #e0e0e0;
            overflow-x: hidden;
        }

        .header {
            background: rgba(20, 20, 30, 0.95);
            backdrop-filter: blur(20px);
            padding: 20px 40px;
            border-bottom: 1px solid rgba(100, 100, 255, 0.3);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: inline-block;
        }

        .header .subtitle {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            margin-top: 5px;
        }

        .container {
            display: flex;
            height: calc(100vh - 80px);
        }

        .sidebar {
            width: 320px;
            background: rgba(20, 20, 30, 0.95);
            backdrop-filter: blur(20px);
            padding: 24px;
            overflow-y: auto;
            border-right: 1px solid rgba(100, 100, 255, 0.2);
        }

        .main-content {
            flex: 1;
            padding: 24px;
            overflow: hidden;
        }

        .control-group {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .control-group:last-child {
            border-bottom: none;
        }

        .control-group h3 {
            color: #667eea;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 16px;
        }

        input[type="text"] {
            width: 100%;
            padding: 12px;
            background: rgba(40, 40, 60, 0.6);
            border: 1px solid rgba(100, 100, 255, 0.3);
            border-radius: 8px;
            color: #fff;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 12px;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button.secondary {
            background: linear-gradient(135deg, #434343 0%, #000000 100%);
        }

        .stats {
            margin-top: 16px;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
        }

        .stat-value {
            color: #4CAF50;
            font-weight: 700;
            font-family: 'Courier New', monospace;
        }

        .color-scheme {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 12px;
        }

        .color-option {
            padding: 10px;
            background: rgba(40, 40, 60, 0.6);
            border: 2px solid transparent;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .color-option:hover {
            border-color: #667eea;
        }

        .color-option.active {
            border-color: #4CAF50;
            background: rgba(76, 175, 80, 0.2);
        }

        #flamegraph {
            width: 100%;
            height: 100%;
            background: rgba(20, 20, 30, 0.5);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .frame {
            cursor: pointer;
            stroke: rgba(0, 0, 0, 0.4);
            stroke-width: 0.5;
            transition: all 0.15s ease;
        }

        .frame:hover {
            stroke: #fff;
            stroke-width: 2;
            filter: brightness(1.3);
        }

        .frame.dimmed {
            opacity: 0.2;
        }

        .frame-text {
            font-size: 11px;
            font-weight: 500;
            fill: rgba(0, 0, 0, 0.9);
            pointer-events: none;
            user-select: none;
        }

        #tooltip {
            position: fixed;
            background: rgba(0, 0, 0, 0.95);
            color: #fff;
            padding: 16px 20px;
            border-radius: 10px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease;
            font-size: 13px;
            border: 1px solid rgba(102, 126, 234, 0.5);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.8);
            z-index: 10000;
            max-width: 450px;
            line-height: 1.6;
        }

        #tooltip.visible {
            opacity: 1;
        }

        .tooltip-header {
            font-weight: 700;
            font-size: 14px;
            margin-bottom: 8px;
            color: #667eea;
        }

        .tooltip-row {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
        }

        .tooltip-label {
            color: rgba(255, 255, 255, 0.7);
        }

        .tooltip-value {
            font-weight: 600;
            color: #4CAF50;
            font-family: 'Courier New', monospace;
        }

        #breadcrumb {
            background: rgba(40, 40, 60, 0.6);
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 13px;
            font-family: 'Courier New', monospace;
            color: rgba(255, 255, 255, 0.8);
        }

        .breadcrumb-item {
            display: inline-block;
            margin: 0 4px;
        }

        .breadcrumb-separator {
            color: rgba(255, 255, 255, 0.3);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .loading {
            animation: pulse 1.5s ease-in-out infinite;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.2);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.8);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üî• vtracer Flame Graph</h1>
        <div class="subtitle">Interactive JVM Performance Profiling</div>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="control-group">
                <h3>üîç Search</h3>
                <input type="text" id="search" placeholder="Search methods...">
            </div>

            <div class="control-group">
                <h3>üé® Color Scheme</h3>
                <div class="color-scheme">
                    <div class="color-option active" data-scheme="java">Java</div>
                    <div class="color-option" data-scheme="hot">Hot</div>
                    <div class="color-option" data-scheme="cool">Cool</div>
                    <div class="color-option" data-scheme="rainbow">Rainbow</div>
                    <div class="color-option" data-scheme="mono">Mono</div>
                    <div class="color-option" data-scheme="perf">Perf</div>
                </div>
            </div>

            <div class="control-group">
                <h3>‚öôÔ∏è Controls</h3>
                <div class="button-group">
                    <button onclick="resetZoom()">Reset</button>
                    <button onclick="exportSVG()" class="secondary">Export</button>
                    <button onclick="toggleLabels()">Labels</button>
                    <button onclick="shareView()" class="secondary">Share</button>
                </div>
            </div>

            <div class="control-group">
                <h3>üìä Statistics</h3>
                <div class="stats" id="stats"></div>
            </div>

            <div class="control-group">
                <h3>üî• Hot Methods</h3>
                <div id="hotMethods" style="font-size: 12px; max-height: 200px; overflow-y: auto;"></div>
            </div>
        </div>

        <div class="main-content">
            <div id="breadcrumb">Root</div>
            <div id="flamegraph"></div>
        </div>
    </div>

    <div id="tooltip"></div>

    <script>
        // Configuration
        const config = {
            width: 0,
            height: 0,
            frameHeight: 18,
            paddingX: 2,
            paddingY: 1,
            minFrameWidth: 0.5,
            transitionDuration: 600
        };

        const colorSchemes = {
            java: (d) => {
                const name = d.data.name.toLowerCase();
                if (name.includes('java.') || name.includes('javax.')) return '#3498db';
                if (name.includes('org.springframework') || name.includes('org.apache')) return '#e67e22';
                if (name.includes('com.example')) return '#e74c3c';
                return '#95a5a6';
            },
            hot: d3.scaleSequential(d3.interpolateYlOrRd).domain([0, 1]),
            cool: d3.scaleSequential(d3.interpolateCool).domain([0, 1]),
            rainbow: d3.scaleSequential(d3.interpolateRainbow).domain([0, 1]),
            mono: d3.scaleSequential(d3.interpolateGreys).domain([0.3, 0.9]),
            perf: d3.scaleSequential(d3.interpolatePlasma).domain([0, 1])
        };

        let currentScheme = 'java';
        let data, svg, root, currentRoot, partition;
        let showLabels = true;

        // Initialize
        window.addEventListener('load', init);

        function init() {
            const container = document.getElementById('flamegraph');
            config.width = container.clientWidth;
            config.height = container.clientHeight - 50;

            // Generate sample data if no data file exists
            loadData();

            // Event listeners
            document.getElementById('search').addEventListener('input', handleSearch);
            document.querySelectorAll('.color-option').forEach(opt => {
                opt.addEventListener('click', (e) => {
                    document.querySelectorAll('.color-option').forEach(o => o.classList.remove('active'));
                    e.target.classList.add('active');
                    currentScheme = e.target.dataset.scheme;
                    render(currentRoot);
                });
            });

            window.addEventListener('resize', debounce(() => {
                config.width = container.clientWidth;
                config.height = container.clientHeight - 50;
                render(currentRoot);
            }, 250));
        }

        function loadData() {
            // Try to load from external file first
            fetch('flamegraph-data.json')
                .then(r => r.json())
                .then(jsonData => {
                    processData(jsonData.flamegraph || jsonData);
                })
                .catch(() => {
                    // Generate sample data for demo
                    const sampleData = generateSampleData();
                    processData(sampleData);
                });
        }

        function generateSampleData() {
            return {
                name: "root",
                value: 1000000,
                children: [
                    {
                        name: "java.lang.Thread.run",
                        value: 1000000,
                        children: [
                            {
                                name: "org.springframework.web.DispatcherServlet.doService",
                                value: 850000,
                                children: [
                                    {
                                        name: "com.example.controller.UserController.getUsers",
                                        value: 650000,
                                        children: [
                                            { name: "com.example.service.UserService.findAll", value: 500000 },
                                            { name: "com.example.mapper.UserMapper.toDto", value: 150000 }
                                        ]
                                    },
                                    { name: "org.springframework.web.method.HandlerMethod.invoke", value: 200000 }
                                ]
                            },
                            { name: "org.apache.tomcat.util.threads.TaskThread.run", value: 150000 }
                        ]
                    }
                ]
            };
        }

        function processData(jsonData) {
            data = jsonData;
            root = d3.hierarchy(data)
                .sum(d => d.value)
                .sort((a, b) => b.value - a.value);

            currentRoot = root;

            partition = d3.partition()
                .size([config.width, config.height])
                .padding(config.paddingY);

            partition(root);

            svg = d3.select('#flamegraph')
                .append('svg')
                .attr('width', config.width)
                .attr('height', config.height);

            render(root);
            updateStats(root);
            updateHotMethods(root);
        }

        function render(node) {
            const descendants = node.descendants();

            // Update breadcrumb
            updateBreadcrumb(node);

            // Bind data
            const cells = svg.selectAll('g')
                .data(descendants, d => d.data.name + d.depth);

            // Exit
            cells.exit().remove();

            // Enter + Update
            const cellsEnter = cells.enter()
                .append('g')
                .attr('class', 'cell');

            cellsEnter.append('rect')
                .attr('class', 'frame');

            cellsEnter.append('text')
                .attr('class', 'frame-text');

            const allCells = cellsEnter.merge(cells);

            allCells.transition()
                .duration(config.transitionDuration)
                .attr('transform', d => `translate(${d.x0},${d.y0})`);

            allCells.select('rect')
                .attr('width', d => Math.max(0, d.x1 - d.x0 - config.paddingX))
                .attr('height', config.frameHeight)
                .attr('fill', d => getColor(d))
                .on('click', (event, d) => zoom(d))
                .on('mouseenter', showTooltip)
                .on('mouseleave', hideTooltip);

            allCells.select('text')
                .attr('x', 4)
                .attr('y', config.frameHeight / 2)
                .attr('dy', '0.35em')
                .style('display', showLabels ? 'block' : 'none')
                .text(d => getLabel(d, d.x1 - d.x0));

            updateStats(node);
        }

        function getColor(d) {
            if (typeof colorSchemes[currentScheme] === 'function') {
                if (currentScheme === 'java') {
                    return colorSchemes[currentScheme](d);
                }
                const t = d.depth / root.height;
                return colorSchemes[currentScheme](t);
            }
            return '#666';
        }

        function getLabel(d, width) {
            if (width < 30) return '';
            const name = d.data.name;
            const maxChars = Math.floor(width / 7);
            return name.length > maxChars ? name.substring(0, maxChars - 3) + '...' : name;
        }

        function zoom(d) {
            if (d === currentRoot) return;

            currentRoot = d;

            const scale = config.width / (d.x1 - d.x0);
            const translateX = -d.x0 * scale;

            svg.selectAll('g')
                .transition()
                .duration(config.transitionDuration)
                .attr('transform', n => {
                    const x = (n.x0 - d.x0) * scale;
                    const y = n.y0 - d.y0;
                    return `translate(${x},${y})`;
                })
                .select('rect')
                .attr('width', n => Math.max(0, (n.x1 - n.x0) * scale - config.paddingX));

            updateBreadcrumb(d);
            updateStats(d);
        }

        function resetZoom() {
            zoom(root);
        }

        function showTooltip(event, d) {
            const tooltip = document.getElementById('tooltip');
            const percent = (100 * d.value / root.value).toFixed(2);
            const selfPercent = d.children 
                ? (100 * (d.value - d.children.reduce((sum, c) => sum + c.value, 0)) / root.value).toFixed(2)
                : percent;

            tooltip.innerHTML = `
                <div class="tooltip-header">${d.data.name}</div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Total Time:</span>
                    <span class="tooltip-value">${formatTime(d.value)}</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Percentage:</span>
                    <span class="tooltip-value">${percent}%</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Self Time:</span>
                    <span class="tooltip-value">${selfPercent}%</span>
                </div>
                <div class="tooltip-row">
                    <span class="tooltip-label">Depth:</span>
                    <span class="tooltip-value">${d.depth}</span>
                </div>
            `;

            tooltip.classList.add('visible');
            positionTooltip(event);
        }

        function positionTooltip(event) {
            const tooltip = document.getElementById('tooltip');
            const x = event.pageX + 15;
            const y = event.pageY + 15;
            
            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
        }

        function hideTooltip() {
            document.getElementById('tooltip').classList.remove('visible');
        }

        function updateBreadcrumb(node) {
            const path = [];
            let current = node;
            while (current) {
                path.unshift(current);
                current = current.parent;
            }

            const breadcrumb = document.getElementById('breadcrumb');
            breadcrumb.innerHTML = path
                .map((n, i) => `
                    <span class="breadcrumb-item" onclick="zoom(root${path.slice(1, i + 1).map((_, j) => `.children[${j}]`).join('')})" style="cursor: pointer;">
                        ${n.data.name}
                    </span>
                    ${i < path.length - 1 ? '<span class="breadcrumb-separator">‚Ä∫</span>' : ''}
                `)
                .join('');
        }

        function updateStats(node) {
            const stats = document.getElementById('stats');
            const descendants = node.descendants();
            
            stats.innerHTML = `
                <div class="stat-item">
                    <span>Total Time</span>
                    <span class="stat-value">${formatTime(node.value)}</span>
                </div>
                <div class="stat-item">
                    <span>Max Depth</span>
                    <span class="stat-value">${node.height}</span>
                </div>
                <div class="stat-item">
                    <span>Total Frames</span>
                    <span class="stat-value">${descendants.length}</span>
                </div>
                <div class="stat-item">
                    <span>Visible Frames</span>
                    <span class="stat-value">${descendants.filter(d => (d.x1 - d.x0) > config.minFrameWidth).length}</span>
                </div>
            `;
        }

        function updateHotMethods(node) {
            const hot = node.descendants()
                .filter(d => !d.children || d.children.length === 0)
                .sort((a, b) => b.value - a.value)
                .slice(0, 10);

            const hotMethods = document.getElementById('hotMethods');
            hotMethods.innerHTML = hot.map((d, i) => `
                <div style="padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.1); cursor: pointer;" onclick="zoom(root${getPathToNode(d)})">
                    <div style="color: #4CAF50; font-weight: 600;">${i + 1}. ${d.data.name}</div>
                    <div style="color: rgba(255,255,255,0.5); font-size: 11px;">${formatTime(d.value)} (${(100 * d.value / root.value).toFixed(1)}%)</div>
                </div>
            `).join('');
        }

        function getPathToNode(node) {
            const path = [];
            let current = node;
            while (current.parent) {
                const index = current.parent.children.indexOf(current);
                path.unshift(`.children[${index}]`);
                current = current.parent;
            }
            return path.join('');
        }

        function handleSearch(e) {
            const query = e.target.value.toLowerCase();
            
            svg.selectAll('.frame')
                .classed('dimmed', d => {
                    if (!query) return false;
                    return !d.data.name.toLowerCase().includes(query);
                });
        }

        function toggleLabels() {
            showLabels = !showLabels;
            svg.selectAll('.frame-text')
                .style('display', showLabels ? 'block' : 'none');
        }

        function exportSVG() {
            const svgData = new XMLSerializer().serializeToString(svg.node());
            const blob = new Blob([svgData], {type: 'image/svg+xml'});
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'flamegraph.svg';
            link.click();
        }

        function shareView() {
            const url = new URL(window.location);
            url.searchParams.set('node', currentRoot.data.name);
            navigator.clipboard.writeText(url.toString());
            alert('View link copied to clipboard!');
        }

        function formatTime(ns) {
            if (ns < 1000) return ns + ' ns';
            if (ns < 1000000) return (ns / 1000).toFixed(2) + ' Œºs';
            if (ns < 1000000000) return (ns / 1000000).toFixed(2) + ' ms';
            return (ns / 1000000000).toFixed(2) + ' s';
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
    </script>
</body>
</html>